/*
  Migration: מניעת שיעורים כפולים

  הקשר:
  - בארגון "חיים בתנועה", הלו"ז חוזר על עצמו כל שבוע
  - אותו שיעור (מדריך + מיקום + יום בשבוע + שעה) מתרחש מדי שבוע
  - זה נורמלי ורצוי!

  הבעיה שנמצאה:
  - באג בפונקציית השכפול (ensureFutureWeeks) יצר שיעורים כפולים באותו תאריך מדויק
  - למשל: 2 שיעורים ב-2026-02-10 בשעה 10:00 עם אותו מדריך ומיקום
  - זה לא אמור לקרות!

  הפתרון:
  - Constraint שמונע יצירת שיעור כפול באותו תאריך מדויק
  - מאפשר את אותו שיעור בתאריכים שונים (שבוע אחרי שבוע)

  דוגמה למה שמותר:
    ✅ 2026-02-10 10:00 מדריך A, גן 1
    ✅ 2026-02-17 10:00 מדריך A, גן 1  <- שבוע אחרי, מותר!
    ✅ 2026-02-24 10:00 מדריך A, גן 1  <- שבוע נוסף, מותר!

  דוגמה למה שאסור:
    ✅ 2026-02-10 10:00 מדריך A, גן 1
    ❌ 2026-02-10 10:00 מדריך A, גן 1  <- אותו תאריך! אסור!
*/

-- הוספת constraint למניעת כפילויות באותו תאריך
ALTER TABLE lessons
ADD CONSTRAINT unique_lesson_schedule
UNIQUE (instructor_id, location_id, lesson_date, start_time);

-- הוספת comment לטבלה להסבר
COMMENT ON CONSTRAINT unique_lesson_schedule ON lessons IS
'מונע שיעורים כפולים באותו תאריך מדויק. מאפשר אותו שיעור (מדריך+מיקום+שעה) בתאריכים שונים (לו"ז שבועי חוזר).';
