-- ============================================================
-- Populate weekly_lesson_assignments from classes_list.csv
-- 11 instructors × 27 weeks (01/02/2026 - 26/07/2026)
--
-- Instructor order (columns in CSV):
-- סתיו, אריאל ברמן, קרן, טליה, אורית, אורי וויס, רמי, מורן דגיר, עליזה, חווי, טל
-- ============================================================

-- Step 1: Update rotation_order for all 11 instructors
UPDATE instructors SET rotation_order = 1  WHERE full_name = 'סתיו דהן';
UPDATE instructors SET rotation_order = 2  WHERE full_name = 'אריאל ברמן';
UPDATE instructors SET rotation_order = 3  WHERE full_name = 'קרן ינוב';
UPDATE instructors SET rotation_order = 4  WHERE full_name = 'טליה דודזון';
UPDATE instructors SET rotation_order = 5  WHERE full_name = 'אורית צ''קול';
UPDATE instructors SET rotation_order = 6  WHERE full_name = 'אורי וויס';
UPDATE instructors SET rotation_order = 7  WHERE full_name = 'רמי שמש';
UPDATE instructors SET rotation_order = 8  WHERE full_name = 'מורן דגיר';
UPDATE instructors SET rotation_order = 9  WHERE full_name = 'עליזה אברבנל';
UPDATE instructors SET rotation_order = 10 WHERE full_name = 'חוי פוקס';
UPDATE instructors SET rotation_order = 11 WHERE full_name = 'טל שומרת';

-- Step 2: Ensure all lesson plans from CSV exist
-- Remove the week_number 1-53 check constraint so we can add more lesson plans
ALTER TABLE lesson_plans DROP CONSTRAINT IF EXISTS lesson_plans_week_number_check;

DO $$
DECLARE
  v_name TEXT;
  v_category TEXT;
  v_next_week_num INT;
BEGIN
  FOR v_name, v_category IN
    VALUES
      ('מיומנות יסוד 2', 'מיומנות יסוד'),
      ('מיומנות יסוד 7', 'מיומנות יסוד'),
      ('מיומנויות יסוד 6', 'מיומנות יסוד'),
      ('גמישות ותנועה 4', 'גמישות ותנועה'),
      ('גמישות ותנועה 5', 'גמישות ותנועה'),
      ('גמישות ותנועה 6', 'גמישות ותנועה')
  LOOP
    IF NOT EXISTS (SELECT 1 FROM lesson_plans WHERE name = v_name) THEN
      SELECT COALESCE(MAX(week_number), 0) + 1 INTO v_next_week_num FROM lesson_plans;
      INSERT INTO lesson_plans (week_number, name, category)
      VALUES (v_next_week_num, v_name, v_category);
      RAISE NOTICE 'Created lesson plan: % (week_number=%)', v_name, v_next_week_num;
    END IF;
  END LOOP;
END $$;

-- Step 3: Clear existing future assignments
DELETE FROM equipment_confirmations
WHERE assignment_id IN (
  SELECT id FROM weekly_lesson_assignments WHERE week_start_date >= '2026-02-01'
);

DELETE FROM weekly_lesson_assignments
WHERE week_start_date >= '2026-02-01';

-- Step 4: Insert all assignments from CSV data
-- Using a staging temp table for clarity
CREATE TEMP TABLE csv_assignments (
  week_date DATE,
  instructor_name TEXT,
  lesson_name TEXT
);

-- Week 1: 01/02/2026
INSERT INTO csv_assignments VALUES
  ('2026-02-01', 'סתיו דהן', 'שיווי משקל 3'),
  ('2026-02-01', 'אריאל ברמן', 'שיווי משקל 2'),
  ('2026-02-01', 'קרן ינוב', 'פתיחת שנה 4'),
  ('2026-02-01', 'טליה דודזון', 'שיווי משקל 1'),
  ('2026-02-01', 'אורית צ''קול', 'מיומנות יסוד 10'),
  ('2026-02-01', 'רמי שמש', 'מיומנות יסוד 5'),
  ('2026-02-01', 'עליזה אברבנל', 'גמישות תנועה 3'),
  ('2026-02-01', 'חוי פוקס', 'מיומנות יסוד 9'),
  ('2026-02-01', 'טל שומרת', 'מיומנות יסוד 3');

-- Week 2: 08/02/2026
INSERT INTO csv_assignments VALUES
  ('2026-02-08', 'סתיו דהן', 'שיווי משקל 6'),
  ('2026-02-08', 'אריאל ברמן', 'שיווי משקל 3'),
  ('2026-02-08', 'קרן ינוב', 'שיווי משקל 2'),
  ('2026-02-08', 'טליה דודזון', 'פתיחת שנה 4'),
  ('2026-02-08', 'אורית צ''קול', 'שיווי משקל 1'),
  ('2026-02-08', 'רמי שמש', 'מיומנות יסוד 10'),
  ('2026-02-08', 'עליזה אברבנל', 'מיומנות יסוד 5'),
  ('2026-02-08', 'חוי פוקס', 'גמישות תנועה 3'),
  ('2026-02-08', 'טל שומרת', 'מיומנות יסוד 9');

-- Week 3: 15/02/2026
INSERT INTO csv_assignments VALUES
  ('2026-02-15', 'סתיו דהן', 'שיווי משקל 11'),
  ('2026-02-15', 'אריאל ברמן', 'שיווי משקל 6'),
  ('2026-02-15', 'קרן ינוב', 'שיווי משקל 3'),
  ('2026-02-15', 'טליה דודזון', 'שיווי משקל 2'),
  ('2026-02-15', 'אורית צ''קול', 'פתיחת שנה 4'),
  ('2026-02-15', 'רמי שמש', 'שיווי משקל 1'),
  ('2026-02-15', 'עליזה אברבנל', 'מיומנות יסוד 10'),
  ('2026-02-15', 'חוי פוקס', 'מיומנות יסוד 5'),
  ('2026-02-15', 'טל שומרת', 'גמישות תנועה 3');

-- Week 4: 22/02/2026
INSERT INTO csv_assignments VALUES
  ('2026-02-22', 'סתיו דהן', 'שיווי משקל 7'),
  ('2026-02-22', 'אריאל ברמן', 'שיווי משקל 11'),
  ('2026-02-22', 'קרן ינוב', 'שיווי משקל 6'),
  ('2026-02-22', 'טליה דודזון', 'שיווי משקל 3'),
  ('2026-02-22', 'אורית צ''קול', 'שיווי משקל 2'),
  ('2026-02-22', 'אורי וויס', 'מיומנויות יסוד 6'),
  ('2026-02-22', 'רמי שמש', 'מיומנות יסוד 7'),
  ('2026-02-22', 'מורן דגיר', 'שיווי משקל 1'),
  ('2026-02-22', 'עליזה אברבנל', 'מיומנות יסוד 2'),
  ('2026-02-22', 'חוי פוקס', 'מיומנות יסוד 10'),
  ('2026-02-22', 'טל שומרת', 'מיומנות יסוד 5');

-- Week 5: 01/03/2026
INSERT INTO csv_assignments VALUES
  ('2026-03-01', 'סתיו דהן', 'שיווי משקל 5'),
  ('2026-03-01', 'אריאל ברמן', 'שיווי משקל 7'),
  ('2026-03-01', 'קרן ינוב', 'שיווי משקל 11'),
  ('2026-03-01', 'טליה דודזון', 'שיווי משקל 6'),
  ('2026-03-01', 'אורית צ''קול', 'שיווי משקל 3'),
  ('2026-03-01', 'אורי וויס', 'שיווי משקל 2'),
  ('2026-03-01', 'רמי שמש', 'מיומנויות יסוד 6'),
  ('2026-03-01', 'מורן דגיר', 'מיומנות יסוד 7'),
  ('2026-03-01', 'עליזה אברבנל', 'שיווי משקל 1'),
  ('2026-03-01', 'חוי פוקס', 'מיומנות יסוד 2'),
  ('2026-03-01', 'טל שומרת', 'מיומנות יסוד 10');

-- Week 6: 08/03/2026
INSERT INTO csv_assignments VALUES
  ('2026-03-08', 'סתיו דהן', 'שיווי משקל 8'),
  ('2026-03-08', 'אריאל ברמן', 'שיווי משקל 5'),
  ('2026-03-08', 'קרן ינוב', 'שיווי משקל 7'),
  ('2026-03-08', 'טליה דודזון', 'שיווי משקל 11'),
  ('2026-03-08', 'אורית צ''קול', 'שיווי משקל 6'),
  ('2026-03-08', 'אורי וויס', 'שיווי משקל 3'),
  ('2026-03-08', 'רמי שמש', 'שיווי משקל 2'),
  ('2026-03-08', 'מורן דגיר', 'מיומנויות יסוד 6'),
  ('2026-03-08', 'עליזה אברבנל', 'מיומנות יסוד 7'),
  ('2026-03-08', 'חוי פוקס', 'שיווי משקל 1'),
  ('2026-03-08', 'טל שומרת', 'מיומנות יסוד 2');

-- Week 7: 15/03/2026
INSERT INTO csv_assignments VALUES
  ('2026-03-15', 'סתיו דהן', 'שיווי משקל 10'),
  ('2026-03-15', 'אריאל ברמן', 'שיווי משקל 8'),
  ('2026-03-15', 'קרן ינוב', 'שיווי משקל 5'),
  ('2026-03-15', 'טליה דודזון', 'שיווי משקל 7'),
  ('2026-03-15', 'אורית צ''קול', 'שיווי משקל 11'),
  ('2026-03-15', 'אורי וויס', 'שיווי משקל 6'),
  ('2026-03-15', 'רמי שמש', 'שיווי משקל 3'),
  ('2026-03-15', 'מורן דגיר', 'שיווי משקל 2'),
  ('2026-03-15', 'עליזה אברבנל', 'מיומנויות יסוד 6'),
  ('2026-03-15', 'חוי פוקס', 'מיומנות יסוד 7'),
  ('2026-03-15', 'טל שומרת', 'שיווי משקל 1');

-- Week 8: 22/03/2026
INSERT INTO csv_assignments VALUES
  ('2026-03-22', 'סתיו דהן', 'שיווי משקל 12'),
  ('2026-03-22', 'אריאל ברמן', 'שיווי משקל 10'),
  ('2026-03-22', 'קרן ינוב', 'שיווי משקל 8'),
  ('2026-03-22', 'טליה דודזון', 'שיווי משקל 5'),
  ('2026-03-22', 'אורית צ''קול', 'שיווי משקל 7'),
  ('2026-03-22', 'אורי וויס', 'שיווי משקל 11'),
  ('2026-03-22', 'רמי שמש', 'שיווי משקל 6'),
  ('2026-03-22', 'מורן דגיר', 'שיווי משקל 3'),
  ('2026-03-22', 'עליזה אברבנל', 'שיווי משקל 2'),
  ('2026-03-22', 'חוי פוקס', 'מיומנויות יסוד 6'),
  ('2026-03-22', 'טל שומרת', 'מיומנות יסוד 7');

-- Week 9: 29/03/2026
INSERT INTO csv_assignments VALUES
  ('2026-03-29', 'סתיו דהן', 'שיווי משקל 13'),
  ('2026-03-29', 'אריאל ברמן', 'שיווי משקל 12'),
  ('2026-03-29', 'קרן ינוב', 'שיווי משקל 10'),
  ('2026-03-29', 'טליה דודזון', 'שיווי משקל 8'),
  ('2026-03-29', 'אורית צ''קול', 'שיווי משקל 5'),
  ('2026-03-29', 'אורי וויס', 'שיווי משקל 7'),
  ('2026-03-29', 'רמי שמש', 'שיווי משקל 11'),
  ('2026-03-29', 'מורן דגיר', 'שיווי משקל 6'),
  ('2026-03-29', 'עליזה אברבנל', 'שיווי משקל 3'),
  ('2026-03-29', 'חוי פוקס', 'שיווי משקל 2'),
  ('2026-03-29', 'טל שומרת', 'מיומנויות יסוד 6');

-- Week 10: 05/04/2026
INSERT INTO csv_assignments VALUES
  ('2026-04-05', 'סתיו דהן', 'משחקי כדור 1'),
  ('2026-04-05', 'אריאל ברמן', 'שיווי משקל 13'),
  ('2026-04-05', 'קרן ינוב', 'שיווי משקל 12'),
  ('2026-04-05', 'טליה דודזון', 'שיווי משקל 10'),
  ('2026-04-05', 'אורית צ''קול', 'שיווי משקל 8'),
  ('2026-04-05', 'אורי וויס', 'שיווי משקל 5'),
  ('2026-04-05', 'רמי שמש', 'שיווי משקל 7'),
  ('2026-04-05', 'מורן דגיר', 'שיווי משקל 11'),
  ('2026-04-05', 'עליזה אברבנל', 'שיווי משקל 6'),
  ('2026-04-05', 'חוי פוקס', 'שיווי משקל 3'),
  ('2026-04-05', 'טל שומרת', 'שיווי משקל 2');

-- Week 11: 12/04/2026
INSERT INTO csv_assignments VALUES
  ('2026-04-12', 'סתיו דהן', 'משחקי כדור 2'),
  ('2026-04-12', 'אריאל ברמן', 'משחקי כדור 1'),
  ('2026-04-12', 'קרן ינוב', 'שיווי משקל 13'),
  ('2026-04-12', 'טליה דודזון', 'שיווי משקל 12'),
  ('2026-04-12', 'אורית צ''קול', 'שיווי משקל 10'),
  ('2026-04-12', 'אורי וויס', 'שיווי משקל 8'),
  ('2026-04-12', 'רמי שמש', 'שיווי משקל 5'),
  ('2026-04-12', 'מורן דגיר', 'שיווי משקל 7'),
  ('2026-04-12', 'עליזה אברבנל', 'שיווי משקל 11'),
  ('2026-04-12', 'חוי פוקס', 'שיווי משקל 6'),
  ('2026-04-12', 'טל שומרת', 'שיווי משקל 3');

-- Week 12: 19/04/2026
INSERT INTO csv_assignments VALUES
  ('2026-04-19', 'סתיו דהן', 'משחקי כדור 3'),
  ('2026-04-19', 'אריאל ברמן', 'משחקי כדור 2'),
  ('2026-04-19', 'קרן ינוב', 'משחקי כדור 1'),
  ('2026-04-19', 'טליה דודזון', 'שיווי משקל 13'),
  ('2026-04-19', 'אורית צ''קול', 'שיווי משקל 12'),
  ('2026-04-19', 'אורי וויס', 'שיווי משקל 10'),
  ('2026-04-19', 'רמי שמש', 'שיווי משקל 8'),
  ('2026-04-19', 'מורן דגיר', 'שיווי משקל 5'),
  ('2026-04-19', 'עליזה אברבנל', 'שיווי משקל 7'),
  ('2026-04-19', 'חוי פוקס', 'שיווי משקל 11'),
  ('2026-04-19', 'טל שומרת', 'שיווי משקל 6');

-- Week 13: 26/04/2026
INSERT INTO csv_assignments VALUES
  ('2026-04-26', 'סתיו דהן', 'משחקי כדור 5'),
  ('2026-04-26', 'אריאל ברמן', 'משחקי כדור 3'),
  ('2026-04-26', 'קרן ינוב', 'משחקי כדור 2'),
  ('2026-04-26', 'טליה דודזון', 'משחקי כדור 1'),
  ('2026-04-26', 'אורית צ''קול', 'שיווי משקל 13'),
  ('2026-04-26', 'אורי וויס', 'שיווי משקל 12'),
  ('2026-04-26', 'רמי שמש', 'שיווי משקל 10'),
  ('2026-04-26', 'מורן דגיר', 'שיווי משקל 8'),
  ('2026-04-26', 'עליזה אברבנל', 'שיווי משקל 5'),
  ('2026-04-26', 'חוי פוקס', 'שיווי משקל 7'),
  ('2026-04-26', 'טל שומרת', 'שיווי משקל 11');

-- Week 14: 03/05/2026
INSERT INTO csv_assignments VALUES
  ('2026-05-03', 'סתיו דהן', 'משחקי כדור 7'),
  ('2026-05-03', 'אריאל ברמן', 'משחקי כדור 5'),
  ('2026-05-03', 'קרן ינוב', 'משחקי כדור 3'),
  ('2026-05-03', 'טליה דודזון', 'משחקי כדור 2'),
  ('2026-05-03', 'אורית צ''קול', 'משחקי כדור 1'),
  ('2026-05-03', 'אורי וויס', 'שיווי משקל 13'),
  ('2026-05-03', 'רמי שמש', 'שיווי משקל 12'),
  ('2026-05-03', 'מורן דגיר', 'שיווי משקל 10'),
  ('2026-05-03', 'עליזה אברבנל', 'שיווי משקל 8'),
  ('2026-05-03', 'חוי פוקס', 'שיווי משקל 5'),
  ('2026-05-03', 'טל שומרת', 'שיווי משקל 7');

-- Week 15: 10/05/2026
INSERT INTO csv_assignments VALUES
  ('2026-05-10', 'סתיו דהן', 'משחקי כדור 4'),
  ('2026-05-10', 'אריאל ברמן', 'משחקי כדור 7'),
  ('2026-05-10', 'קרן ינוב', 'משחקי כדור 5'),
  ('2026-05-10', 'טליה דודזון', 'משחקי כדור 3'),
  ('2026-05-10', 'אורית צ''קול', 'משחקי כדור 2'),
  ('2026-05-10', 'אורי וויס', 'משחקי כדור 1'),
  ('2026-05-10', 'רמי שמש', 'שיווי משקל 13'),
  ('2026-05-10', 'מורן דגיר', 'שיווי משקל 12'),
  ('2026-05-10', 'עליזה אברבנל', 'שיווי משקל 10'),
  ('2026-05-10', 'חוי פוקס', 'שיווי משקל 8'),
  ('2026-05-10', 'טל שומרת', 'שיווי משקל 5');

-- Week 16: 17/05/2026
INSERT INTO csv_assignments VALUES
  ('2026-05-17', 'סתיו דהן', 'משחקי כדור 6'),
  ('2026-05-17', 'אריאל ברמן', 'משחקי כדור 4'),
  ('2026-05-17', 'קרן ינוב', 'משחקי כדור 7'),
  ('2026-05-17', 'טליה דודזון', 'משחקי כדור 5'),
  ('2026-05-17', 'אורית צ''קול', 'משחקי כדור 3'),
  ('2026-05-17', 'אורי וויס', 'משחקי כדור 2'),
  ('2026-05-17', 'רמי שמש', 'משחקי כדור 1'),
  ('2026-05-17', 'מורן דגיר', 'שיווי משקל 13'),
  ('2026-05-17', 'עליזה אברבנל', 'שיווי משקל 12'),
  ('2026-05-17', 'חוי פוקס', 'שיווי משקל 10'),
  ('2026-05-17', 'טל שומרת', 'שיווי משקל 8');

-- Week 17: 24/05/2026
INSERT INTO csv_assignments VALUES
  ('2026-05-24', 'סתיו דהן', 'משחקי כדור 8'),
  ('2026-05-24', 'אריאל ברמן', 'משחקי כדור 6'),
  ('2026-05-24', 'קרן ינוב', 'משחקי כדור 4'),
  ('2026-05-24', 'טליה דודזון', 'משחקי כדור 7'),
  ('2026-05-24', 'אורית צ''קול', 'משחקי כדור 5'),
  ('2026-05-24', 'אורי וויס', 'משחקי כדור 3'),
  ('2026-05-24', 'רמי שמש', 'משחקי כדור 2'),
  ('2026-05-24', 'מורן דגיר', 'משחקי כדור 1'),
  ('2026-05-24', 'עליזה אברבנל', 'שיווי משקל 13'),
  ('2026-05-24', 'חוי פוקס', 'שיווי משקל 12'),
  ('2026-05-24', 'טל שומרת', 'שיווי משקל 10');

-- Week 18: 31/05/2026
INSERT INTO csv_assignments VALUES
  ('2026-05-31', 'סתיו דהן', 'גמישות ותנועה 1'),
  ('2026-05-31', 'אריאל ברמן', 'משחקי כדור 8'),
  ('2026-05-31', 'קרן ינוב', 'משחקי כדור 6'),
  ('2026-05-31', 'טליה דודזון', 'משחקי כדור 4'),
  ('2026-05-31', 'אורית צ''קול', 'משחקי כדור 7'),
  ('2026-05-31', 'אורי וויס', 'משחקי כדור 5'),
  ('2026-05-31', 'רמי שמש', 'משחקי כדור 3'),
  ('2026-05-31', 'מורן דגיר', 'משחקי כדור 2'),
  ('2026-05-31', 'עליזה אברבנל', 'משחקי כדור 1'),
  ('2026-05-31', 'חוי פוקס', 'שיווי משקל 13'),
  ('2026-05-31', 'טל שומרת', 'שיווי משקל 12');

-- Week 19: 07/06/2026
INSERT INTO csv_assignments VALUES
  ('2026-06-07', 'סתיו דהן', 'גמישות ותנועה 2'),
  ('2026-06-07', 'אריאל ברמן', 'גמישות ותנועה 1'),
  ('2026-06-07', 'קרן ינוב', 'משחקי כדור 8'),
  ('2026-06-07', 'טליה דודזון', 'משחקי כדור 6'),
  ('2026-06-07', 'אורית צ''קול', 'משחקי כדור 4'),
  ('2026-06-07', 'אורי וויס', 'משחקי כדור 7'),
  ('2026-06-07', 'רמי שמש', 'משחקי כדור 5'),
  ('2026-06-07', 'מורן דגיר', 'משחקי כדור 3'),
  ('2026-06-07', 'עליזה אברבנל', 'משחקי כדור 2'),
  ('2026-06-07', 'חוי פוקס', 'משחקי כדור 1'),
  ('2026-06-07', 'טל שומרת', 'שיווי משקל 13');

-- Week 20: 14/06/2026
INSERT INTO csv_assignments VALUES
  ('2026-06-14', 'סתיו דהן', 'גמישות ותנועה 4'),
  ('2026-06-14', 'אריאל ברמן', 'גמישות ותנועה 2'),
  ('2026-06-14', 'קרן ינוב', 'גמישות ותנועה 1'),
  ('2026-06-14', 'טליה דודזון', 'משחקי כדור 8'),
  ('2026-06-14', 'אורית צ''קול', 'משחקי כדור 6'),
  ('2026-06-14', 'אורי וויס', 'משחקי כדור 4'),
  ('2026-06-14', 'רמי שמש', 'משחקי כדור 7'),
  ('2026-06-14', 'מורן דגיר', 'משחקי כדור 5'),
  ('2026-06-14', 'עליזה אברבנל', 'משחקי כדור 3'),
  ('2026-06-14', 'חוי פוקס', 'משחקי כדור 2'),
  ('2026-06-14', 'טל שומרת', 'משחקי כדור 1');

-- Week 21: 21/06/2026
INSERT INTO csv_assignments VALUES
  ('2026-06-21', 'סתיו דהן', 'גמישות ותנועה 5'),
  ('2026-06-21', 'אריאל ברמן', 'גמישות ותנועה 4'),
  ('2026-06-21', 'קרן ינוב', 'גמישות ותנועה 2'),
  ('2026-06-21', 'טליה דודזון', 'גמישות ותנועה 1'),
  ('2026-06-21', 'אורית צ''קול', 'משחקי כדור 8'),
  ('2026-06-21', 'אורי וויס', 'משחקי כדור 6'),
  ('2026-06-21', 'רמי שמש', 'משחקי כדור 4'),
  ('2026-06-21', 'מורן דגיר', 'משחקי כדור 7'),
  ('2026-06-21', 'עליזה אברבנל', 'משחקי כדור 5'),
  ('2026-06-21', 'חוי פוקס', 'משחקי כדור 3'),
  ('2026-06-21', 'טל שומרת', 'משחקי כדור 2');

-- Week 22: 28/06/2026
INSERT INTO csv_assignments VALUES
  ('2026-06-28', 'סתיו דהן', 'גמישות ותנועה 6'),
  ('2026-06-28', 'אריאל ברמן', 'גמישות ותנועה 5'),
  ('2026-06-28', 'קרן ינוב', 'גמישות ותנועה 4'),
  ('2026-06-28', 'טליה דודזון', 'גמישות ותנועה 2'),
  ('2026-06-28', 'אורית צ''קול', 'גמישות ותנועה 1'),
  ('2026-06-28', 'אורי וויס', 'משחקי כדור 8'),
  ('2026-06-28', 'רמי שמש', 'משחקי כדור 6'),
  ('2026-06-28', 'מורן דגיר', 'משחקי כדור 4'),
  ('2026-06-28', 'עליזה אברבנל', 'משחקי כדור 7'),
  ('2026-06-28', 'חוי פוקס', 'משחקי כדור 5'),
  ('2026-06-28', 'טל שומרת', 'משחקי כדור 3');

-- Week 23: 05/07/2026
INSERT INTO csv_assignments VALUES
  ('2026-07-05', 'אריאל ברמן', 'גמישות ותנועה 6'),
  ('2026-07-05', 'קרן ינוב', 'גמישות ותנועה 5'),
  ('2026-07-05', 'טליה דודזון', 'גמישות ותנועה 4'),
  ('2026-07-05', 'אורית צ''קול', 'גמישות ותנועה 2'),
  ('2026-07-05', 'אורי וויס', 'גמישות ותנועה 1'),
  ('2026-07-05', 'רמי שמש', 'משחקי כדור 8'),
  ('2026-07-05', 'מורן דגיר', 'משחקי כדור 6'),
  ('2026-07-05', 'עליזה אברבנל', 'משחקי כדור 4'),
  ('2026-07-05', 'חוי פוקס', 'משחקי כדור 7'),
  ('2026-07-05', 'טל שומרת', 'משחקי כדור 5');

-- Week 24: 12/07/2026
-- NOTE: CSV has duplicate 'גמישות ותנועה 6' for אריאל and קרן.
-- First occurrence (אריאל) will be inserted; קרן will be skipped due to unique constraint.
INSERT INTO csv_assignments VALUES
  ('2026-07-12', 'אריאל ברמן', 'גמישות ותנועה 6'),
  ('2026-07-12', 'קרן ינוב', 'גמישות ותנועה 6'),
  ('2026-07-12', 'טליה דודזון', 'גמישות ותנועה 5'),
  ('2026-07-12', 'אורית צ''קול', 'גמישות ותנועה 4'),
  ('2026-07-12', 'אורי וויס', 'גמישות ותנועה 2'),
  ('2026-07-12', 'רמי שמש', 'גמישות ותנועה 1'),
  ('2026-07-12', 'מורן דגיר', 'משחקי כדור 8'),
  ('2026-07-12', 'עליזה אברבנל', 'משחקי כדור 6'),
  ('2026-07-12', 'חוי פוקס', 'משחקי כדור 4'),
  ('2026-07-12', 'טל שומרת', 'משחקי כדור 7');

-- Week 25: 19/07/2026
-- NOTE: CSV has duplicate 'גמישות ותנועה 6' for קרן and טליה.
-- First occurrence (קרן) will be inserted; טליה will be skipped due to unique constraint.
INSERT INTO csv_assignments VALUES
  ('2026-07-19', 'קרן ינוב', 'גמישות ותנועה 6'),
  ('2026-07-19', 'טליה דודזון', 'גמישות ותנועה 6'),
  ('2026-07-19', 'אורית צ''קול', 'גמישות ותנועה 5'),
  ('2026-07-19', 'אורי וויס', 'גמישות ותנועה 4'),
  ('2026-07-19', 'רמי שמש', 'גמישות ותנועה 2'),
  ('2026-07-19', 'מורן דגיר', 'גמישות ותנועה 1'),
  ('2026-07-19', 'עליזה אברבנל', 'משחקי כדור 8'),
  ('2026-07-19', 'חוי פוקס', 'משחקי כדור 6'),
  ('2026-07-19', 'טל שומרת', 'משחקי כדור 4');

-- Week 26: 26/07/2026
INSERT INTO csv_assignments VALUES
  ('2026-07-26', 'אורית צ''קול', 'גמישות ותנועה 6'),
  ('2026-07-26', 'אורי וויס', 'גמישות ותנועה 5'),
  ('2026-07-26', 'רמי שמש', 'גמישות ותנועה 4'),
  ('2026-07-26', 'מורן דגיר', 'גמישות ותנועה 2'),
  ('2026-07-26', 'עליזה אברבנל', 'גמישות ותנועה 1'),
  ('2026-07-26', 'חוי פוקס', 'משחקי כדור 8'),
  ('2026-07-26', 'טל שומרת', 'משחקי כדור 6');

-- Step 5: Insert into weekly_lesson_assignments from staging table
-- Use a DO block to handle both unique constraints (instructor+week and lesson+week)
DO $$
DECLARE
  rec RECORD;
  v_instructor_id UUID;
  v_lesson_id UUID;
  v_count INT := 0;
  v_skipped INT := 0;
  v_not_found INT := 0;
BEGIN
  FOR rec IN SELECT * FROM csv_assignments ORDER BY week_date, instructor_name LOOP
    -- Look up instructor
    SELECT id INTO v_instructor_id
    FROM instructors WHERE full_name = rec.instructor_name;

    IF v_instructor_id IS NULL THEN
      RAISE NOTICE 'Instructor not found: "%"', rec.instructor_name;
      v_not_found := v_not_found + 1;
      CONTINUE;
    END IF;

    -- Look up lesson plan
    SELECT id INTO v_lesson_id
    FROM lesson_plans WHERE name = rec.lesson_name;

    IF v_lesson_id IS NULL THEN
      RAISE NOTICE 'Lesson plan not found: "%"', rec.lesson_name;
      v_not_found := v_not_found + 1;
      CONTINUE;
    END IF;

    -- Check if this lesson is already assigned to someone else this week
    IF EXISTS (
      SELECT 1 FROM weekly_lesson_assignments
      WHERE lesson_plan_id = v_lesson_id AND week_start_date = rec.week_date
    ) THEN
      RAISE NOTICE 'Duplicate lesson "%" on %, skipping for %', rec.lesson_name, rec.week_date, rec.instructor_name;
      v_skipped := v_skipped + 1;
      CONTINUE;
    END IF;

    -- Insert or update assignment
    INSERT INTO weekly_lesson_assignments (instructor_id, lesson_plan_id, week_start_date, is_permanent_change)
    VALUES (v_instructor_id, v_lesson_id, rec.week_date, false)
    ON CONFLICT (instructor_id, week_start_date) DO UPDATE
      SET lesson_plan_id = EXCLUDED.lesson_plan_id,
          updated_at = now();

    v_count := v_count + 1;
  END LOOP;

  RAISE NOTICE 'Done! Inserted/updated: %, Skipped (duplicates): %, Not found: %', v_count, v_skipped, v_not_found;
END $$;

-- Drop temp table
DROP TABLE csv_assignments;

-- ============================================================
-- Verify results
-- ============================================================

-- Show assignment count per week
SELECT
  to_char(wla.week_start_date, 'DD/MM') AS week,
  COUNT(*) AS assignments
FROM weekly_lesson_assignments wla
WHERE wla.week_start_date >= '2026-02-01'
GROUP BY wla.week_start_date
ORDER BY wla.week_start_date;

-- Show current week assignments
SELECT
  i.full_name,
  i.rotation_order,
  lp.name AS lesson_plan,
  wla.week_start_date
FROM weekly_lesson_assignments wla
JOIN instructors i ON i.id = wla.instructor_id
JOIN lesson_plans lp ON lp.id = wla.lesson_plan_id
WHERE wla.week_start_date = '2026-02-15'
ORDER BY i.rotation_order;
